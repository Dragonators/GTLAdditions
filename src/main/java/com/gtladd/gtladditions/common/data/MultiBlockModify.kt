package com.gtladd.gtladditions.common.data

import com.google.common.primitives.Ints
import com.gregtechceu.gtceu.api.data.chemical.ChemicalHelper
import com.gregtechceu.gtceu.api.data.tag.TagPrefix
import com.gregtechceu.gtceu.api.machine.IMachineBlockEntity
import com.gregtechceu.gtceu.api.machine.MetaMachine
import com.gregtechceu.gtceu.api.machine.MultiblockMachineDefinition
import com.gregtechceu.gtceu.api.machine.multiblock.PartAbility
import com.gregtechceu.gtceu.api.pattern.FactoryBlockPattern
import com.gregtechceu.gtceu.api.pattern.Predicates
import com.gregtechceu.gtceu.api.recipe.GTRecipe
import com.gregtechceu.gtceu.api.recipe.OverclockingLogic
import com.gregtechceu.gtceu.api.recipe.logic.OCParams
import com.gregtechceu.gtceu.api.recipe.logic.OCResult
import com.gregtechceu.gtceu.api.recipe.modifier.RecipeModifierList
import com.gregtechceu.gtceu.common.data.GTBlocks
import com.gregtechceu.gtceu.common.data.GTMachines
import com.gregtechceu.gtceu.common.data.GTRecipeModifiers
import com.gregtechceu.gtceu.common.machine.multiblock.electric.ActiveTransformerMachine
import com.gregtechceu.gtceu.utils.SupplierMemoizer
import com.gtladd.gtladditions.api.machine.GTLAddPartAbility
import com.gtladd.gtladditions.api.machine.IThreadModifierMachine
import com.gtladd.gtladditions.common.machine.muiltblock.controller.mutable.CreateAggregation
import com.gtladd.gtladditions.common.machine.muiltblock.controller.mutable.DoorOfCreate
import org.gtlcore.gtlcore.common.data.GTLBlocks
import org.gtlcore.gtlcore.common.data.GTLMaterials
import org.gtlcore.gtlcore.common.data.machines.AdvancedMultiBlockMachine
import org.gtlcore.gtlcore.utils.Registries
import java.util.function.Function

@Suppress("DuplicatedCode")
object MultiBlockModify {
    private val doorofPattern = Function { definition: MultiblockMachineDefinition? ->
        FactoryBlockPattern.start()
            .aisle("                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "              a              ", "             aaa             ", "            aaaaa            ", "           aaaaaaa           ", "          aaaaaaaaa          ", "         aaaaaaaaaaa         ", "        aaaaaaaaaaaaa        ", "         aaaaaaaaaaa         ", "          aaaaaaaaa          ", "           aaaaaaa           ", "            aaaaa            ", "             aaa             ", "              a              ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ")
            .aisle("                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "              a              ", "             aaa             ", "             aaa             ", "             aaa             ", "             aaa             ", "             aaa             ", "             acaa            ", "       aaaaaacccaaaaaa       ", "      aaaaaacccccaaaaaa      ", "       aaaaaacccaaaaaa       ", "            aacaa            ", "             aaa             ", "             aaa             ", "             aaa             ", "             aaa             ", "             aaa             ", "              a              ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ")
            .aisle("                             ", "                             ", "                             ", "                             ", "                             ", "              a              ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "      a               a      ", "     aa               aa     ", "      a               a      ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "              a              ", "                             ", "                             ", "                             ", "                             ", "                             ")
            .aisle("                             ", "                             ", "                             ", "                             ", "              a              ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "     a                 a     ", "    aa                 aa    ", "     a                 a     ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "              a              ", "                             ", "                             ", "                             ", "                             ")
            .aisle("                             ", "                             ", "                             ", "              a              ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "    a                   a    ", "   aa                   aa   ", "    a                   a    ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "              a              ", "                             ", "                             ", "                             ")
            .aisle("                             ", "                             ", "              a              ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "   a                     a   ", "  aa                     aa  ", "   a                     a   ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "              a              ", "                             ", "                             ")
            .aisle("                             ", "              a              ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "  a                       a  ", " aa                       aa ", "  a                       a  ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "              a              ", "                             ")
            .aisle("                             ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", " a                         a ", " a                         a ", " a                         a ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "                             ")
            .aisle("              a              ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", " a                         a ", "aa                         aa", " a                         a ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "              a              ")
            .aisle("             aaa             ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "aa                         aa", "aa                         aa", "aa                         aa", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "             aaa             ")
            .aisle("            aaaaa            ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "a                           a", "aa                         aa", "aa                         aa", "aa                         aa", "a                           a", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "            aaaaa            ")
            .aisle("           aaaaaaa           ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "a                           a", "a                           a", "aa                         aa", "aa                         aa", "aa                         aa", "a                           a", "a                           a", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "           aaaaaaa           ")
            .aisle("          aaaaaaaaa          ", "            aacaa            ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "a                           a", "a                           a", "aa                         aa", "aa                         aa", "ac                         ca", "aa                         aa", "aa                         aa", "a                           a", "a                           a", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "            aacaa            ", "          aaaaaaaaa          ")
            .aisle("         aaaaaaaaaaa         ", "       aaaaaacccaaaaaa       ", "      a               a      ", "     a                 a     ", "    a                   a    ", "   a                     a   ", "  a                       a  ", " a                         a ", " a                         a ", "aa                         aa", "aa                         aa", "aa                         aa", "aa                         aa", "ac                         ca", "ac                         ca", "ac                         ca", "aa                         aa", "aa                         aa", "aa                         aa", "aa                         aa", " a                         a ", " a                         a ", "  a                       a  ", "   a                     a   ", "    a                   a    ", "     a                 a     ", "      a               a      ", "       aaaaaacccaaaaaa       ", "         aaaadddaaaa         ")
            .aisle("        aaaaaaaaaaaaa        ", "      aaaaaacccccaaaaaa      ", "     aa               aa     ", "    aa                 aa    ", "   aa                   aa   ", "  aa                     aa  ", " aa                       aa ", " a                         a ", "aa                         aa", "aa                         aa", "aa                         aa", "aa                         aa", "ac                         ca", "ac                         ca", "ac                         ca", "ac                         ca", "ac                         ca", "aa                         aa", "aa                         aa", "aa                         aa", "aa                         aa", " a                         a ", " aa                       aa ", "  aa                     aa  ", "   aa                   aa   ", "    aa                 aa    ", "     aa               aa     ", "      aaaaaacccccaaaaaa      ", "        aaaaadbdaaaaa        ")
            .aisle("         aaaaaaaaaaa         ", "       aaaaaacccaaaaaa       ", "      a               a      ", "     a                 a     ", "    a                   a    ", "   a                     a   ", "  a                       a  ", " a                         a ", " a                         a ", "aa                         aa", "aa                         aa", "aa                         aa", "aa                         aa", "ac                         ca", "ac                         ca", "ac                         ca", "aa                         aa", "aa                         aa", "aa                         aa", "aa                         aa", " a                         a ", " a                         a ", "  a                       a  ", "   a                     a   ", "    a                   a    ", "     a                 a     ", "      a               a      ", "       aaaaaacccaaaaaa       ", "         aaaadddaaaa         ")
            .aisle("          aaaaaaaaa          ", "            aacaa            ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "a                           a", "a                           a", "aa                         aa", "aa                         aa", "ac                         ca", "aa                         aa", "aa                         aa", "a                           a", "a                           a", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "            aacaa            ", "          aaaaaaaaa          ")
            .aisle("           aaaaaaa           ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "a                           a", "a                           a", "aa                         aa", "aa                         aa", "aa                         aa", "a                           a", "a                           a", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "           aaaaaaa           ")
            .aisle("            aaaaa            ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "a                           a", "aa                         aa", "aa                         aa", "aa                         aa", "a                           a", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "            aaaaa            ")
            .aisle("             aaa             ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "aa                         aa", "aa                         aa", "aa                         aa", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "             aaa             ")
            .aisle("              a              ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", " a                         a ", "aa                         aa", " a                         a ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "              a              ")
            .aisle("                             ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", " a                         a ", " a                         a ", " a                         a ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "                             ")
            .aisle("                             ", "              a              ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "  a                       a  ", " aa                       aa ", "  a                       a  ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "              a              ", "                             ")
            .aisle("                             ", "                             ", "              a              ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "   a                     a   ", "  aa                     aa  ", "   a                     a   ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "              a              ", "                             ", "                             ")
            .aisle("                             ", "                             ", "                             ", "              a              ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "    a                   a    ", "   aa                   aa   ", "    a                   a    ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "              a              ", "                             ", "                             ", "                             ")
            .aisle("                             ", "                             ", "                             ", "                             ", "              a              ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "     a                 a     ", "    aa                 aa    ", "     a                 a     ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "              a              ", "                             ", "                             ", "                             ", "                             ")
            .aisle("                             ", "                             ", "                             ", "                             ", "                             ", "              a              ", "             aaa             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "      a               a      ", "     aa               aa     ", "      a               a      ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "             aaa             ", "              a              ", "                             ", "                             ", "                             ", "                             ", "                             ")
            .aisle("                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "              a              ", "             aaa             ", "             aaa             ", "             aaa             ", "             aaa             ", "             aaa             ", "            aacaa            ", "       aaaaaacccaaaaaa       ", "      aaaaaacccccaaaaaa      ", "       aaaaaacccaaaaaa       ", "            aacaa            ", "             aaa             ", "             aaa             ", "             aaa             ", "             aaa             ", "             aaa             ", "              a              ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ")
            .aisle("                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "              a              ", "             aaa             ", "            aaaaa            ", "           aaaaaaa           ", "          aaaaaaaaa          ", "         aaaaaaaaaaa         ", "        aaaaaaaaaaaaa        ", "         aaaaaaaaaaa         ", "          aaaaaaaaa          ", "           aaaaaaa           ", "            aaaaa            ", "             aaa             ", "              a              ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ", "                             ")
            .where("b", Predicates.controller(Predicates.blocks(AdvancedMultiBlockMachine.DOOR_OF_CREATE.get())))
            .where("a", Predicates.blocks(GTLBlocks.DIMENSION_CONNECTION_CASING.get()))
            .where(
                "d", Predicates.blocks(GTLBlocks.DIMENSION_CONNECTION_CASING.get())
                    .or(Predicates.abilities(PartAbility.IMPORT_ITEMS).setPreviewCount(1))
                    .or(Predicates.abilities(PartAbility.EXPORT_ITEMS).setPreviewCount(1))
                    .or(Predicates.abilities(PartAbility.INPUT_ENERGY).setMaxGlobalLimited(1))
                    .or(Predicates.abilities(GTLAddPartAbility.THREAD_MODIFIER).setMaxGlobalLimited(1))
            )
            .where("c", Predicates.blocks(Registries.getBlock("kubejs:dimension_creation_casing")))
            .where(" ", Predicates.any())
            .build()
    }

    private val createAggregation = Function { definition: MultiblockMachineDefinition? ->
        FactoryBlockPattern.start()
            .aisle("          aaaaaaa          ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "          aaaaaaa          ")
            .aisle("       aaaaaaaaaaaaa       ", "             b             ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "             b             ", "       aaaaaaaaaaaaa       ")
            .aisle("     aaaaaaaaaaaaaaaaa     ", "     c      bbb      c     ", "     c       b       c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c       b       c     ", "     c      bbb      c     ", "     aaaaaaaaaaaaaaaaa     ")
            .aisle("    aaaaaaaaaaaaaaaaaaa    ", "    c       bbb       c    ", "    c       bbb       c    ", "    c        b        c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c        b        c    ", "    c       bbb       c    ", "    c       bbb       c    ", "    aaaaaaaaaaaaaaaaaaa    ")
            .aisle("   aaaaaaaaaaaaaaaaaaaaa   ", "   c         b         c   ", "   c        bbb        c   ", "   c        bbb        c   ", "   c         b         c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c         b         c   ", "   c        bbb        c   ", "   c        bbb        c   ", "   c         b         c   ", "   aaaaaaaaaaaaaaaaaaaaa   ")
            .aisle("  aaaaaaaaaaaaaaaaaaaaaaa  ", "  c                     c  ", "  c          b          c  ", "  c         bbb         c  ", "  c         bbb         c  ", "  c          b          c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c          b          c  ", "  c         bbb         c  ", "  c         bbb         c  ", "  c          b          c  ", "  c                     c  ", "  aaaaaaaaaaaaaaaaaaaaaaa  ")
            .aisle(" aaaaaaaaaaaaaaaaaaaaaaaa  ", "                           ", "                           ", "             b             ", "            bbb            ", "            bbb            ", "             b             ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "             b             ", "            bbb            ", "            bbb            ", "             b             ", "                           ", "                           ", "  aaaaaaaaaaaaaaaaaaaaaaa  ")
            .aisle(" aaaaaaaaaaaaaaaaaaaaaaaaa ", "                           ", "                           ", "                           ", "             b             ", "            bbb            ", "            bbb            ", "             b             ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "             b             ", "            bbb            ", "            bbb            ", "             b             ", "                           ", "                           ", "                           ", " aaaaaaaaaaaaaaaaaaaaaaaaa ")
            .aisle(" aaaaaaaaaaaaaaaaaaaaaaaaa ", "                           ", "                           ", "                           ", "                           ", "             b             ", "            bbb            ", "            bbb            ", "             b             ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "             b             ", "            bbb            ", "            bbb            ", "             b             ", "                           ", "                           ", "                           ", "                           ", " aaaaaaaaaaaaaaaaaaaaaaaaa ")
            .aisle(" aaaaaaaaaaaaaaaaaaaaaaaaa ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", " aaaaaaaaaaaaaaaaaaaaaaaaa ")
            .aisle("aaaaaaaaaaaaaaaaaaaaaaaaaaa", "          ddddddd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          ddddddd          ", "            ddd            ", "            ddd            ", "            ddd            ", "            ddd            ", "            ddd            ", "            ddd            ", "                           ", "                           ", "                           ", "            ddd            ", "            ddd            ", "            ddd            ", "            ddd            ", "            ddd            ", "            ddd            ", "          ddddddd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          ddddddd          ", "aaaaaaaaaaaaaaaaaaaaaaaaaaa")
            .aisle("aaaaaaaaaaaaaaaaaaaaaaaaaaa", "         ddddddddd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         ddddddddd         ", "           d   d           ", "           d   d           ", "           d   d           ", "           d   d           ", "           d   d           ", "           ddddd           ", "                           ", "                           ", "                           ", "           ddddd           ", "           d   d           ", "           d   d           ", "           d   d           ", "           d   d           ", "           d   d           ", "         ddddddddd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         ddddddddd         ", "aaaaaaaaaaaaaaaaaaaaaaaaaaa")
            .aisle("aaaaaaaaaaaaaaaaaaaaaaaaaaa", "  bb     ddddddddd     bb  ", "   bb    d  eee  d    bb   ", "    bb   d  eee  d   bb    ", "     bb  d  eee  d  bb     ", "      bb d  eee  d bb      ", "       bbd  eee  dbb       ", "        bd  eee  db        ", "         dddeeeddd         ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          ddeeedd          ", "            ddd            ", "                           ", "            ddd            ", "          ddeeedd          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "         dddeeeddd         ", "        bd  eee  db        ", "       bbd  eee  dbb       ", "      bb d  eee  d bb      ", "     bb  d  eee  d  bb     ", "    bb   d  eee  d   bb    ", "   bb    d  eee  d    bb   ", "  bb     ddddddddd     bb  ", "aaaaaaaaaaaaaaaaaaaaaaaaaaa")
            .aisle("aaaaaaaaaaaaaaaaaaaaaaaaaaa", " bbbb    ddddddddd    bbbb ", "  bbbb   d  eee  d   bbbb  ", "   bbbb  d  eee  d  bbbb   ", "    bbbb d  eee  d bbbb    ", "     bbbbd  eee  dbbbb     ", "      bbbd  eee  dbbb      ", "       bbd  eee  dbb       ", "        bdddeeedddb        ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          ddeeedd          ", "            dfd            ", "                           ", "            dfd            ", "          ddeeedd          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "        bdddeeedddb        ", "       bbd  eee  dbb       ", "      bbbd  eee  dbbb      ", "     bbbbd  eee  dbbbb     ", "    bbbb d  eee  d bbbb    ", "   bbbb  d  eee  d  bbbb   ", "  bbbb   d  eee  d   bbbb  ", "  bbb    ddddddddd    bbb  ", "aaaaaaaaaaaaa~aaaaaaaaaaaaa")
            .aisle("aaaaaaaaaaaaaaaaaaaaaaaaaaa", "  bb     ddddddddd     bb  ", "   bb    d  eee  d    bb   ", "    bb   d  eee  d   bb    ", "     bb  d  eee  d  bb     ", "      bb d  eee  d bb      ", "       bbd  eee  dbb       ", "        bd  eee  db        ", "         dddeeeddd         ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          ddeeedd          ", "            ddd            ", "                           ", "            ddd            ", "          ddeeedd          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "          d eee d          ", "         dddeeeddd         ", "        bd  eee  db        ", "       bbd  eee  dbb       ", "      bb d  eee  d bb      ", "     bb  d  eee  d  bb     ", "    bb   d  eee  d   bb    ", "   bb    d  eee  d    bb   ", "  bb     ddddddddd     bb  ", "aaaaaaaaaaaaaaaaaaaaaaaaaaa")
            .aisle("aaaaaaaaaaaaaaaaaaaaaaaaaaa", "         ddddddddd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         ddddddddd         ", "           d   d           ", "           d   d           ", "           d   d           ", "           d   d           ", "           d   d           ", "           ddddd           ", "                           ", "                           ", "                           ", "           ddddd           ", "           d   d           ", "           d   d           ", "           d   d           ", "           d   d           ", "           d   d           ", "         ddddddddd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         dd     dd         ", "         ddddddddd         ", "aaaaaaaaaaaaaaaaaaaaaaaaaaa")
            .aisle("aaaaaaaaaaaaaaaaaaaaaaaaaaa", "          ddddddd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          ddddddd          ", "            ddd            ", "            ddd            ", "            ddd            ", "            ddd            ", "            ddd            ", "            ddd            ", "                           ", "                           ", "                           ", "            ddd            ", "            ddd            ", "            ddd            ", "            ddd            ", "            ddd            ", "            ddd            ", "          ddddddd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          dd   dd          ", "          ddddddd          ", "aaaaaaaaaaaaaaaaaaaaaaaaaaa")
            .aisle(" aaaaaaaaaaaaaaaaaaaaaaaaa ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", "           ddddd           ", " aaaaaaaaaaaaaaaaaaaaaaaaa ")
            .aisle(" aaaaaaaaaaaaaaaaaaaaaaaaa ", "                           ", "                           ", "                           ", "                           ", "             b             ", "            bbb            ", "            bbb            ", "             b             ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "             b             ", "            bbb            ", "            bbb            ", "             b             ", "                           ", "                           ", "                           ", "                           ", " aaaaaaaaaaaaaaaaaaaaaaaaa ")
            .aisle(" aaaaaaaaaaaaaaaaaaaaaaaaa ", "                           ", "                           ", "                           ", "             b             ", "            bbb            ", "            bbb            ", "             b             ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "             b             ", "            bbb            ", "            bbb            ", "             b             ", "                           ", "                           ", "                           ", " aaaaaaaaaaaaaaaaaaaaaaaaa ")
            .aisle("  aaaaaaaaaaaaaaaaaaaaaaa  ", "                           ", "                           ", "             b             ", "            bbb            ", "            bbb            ", "             b             ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "             b             ", "            bbb            ", "            bbb            ", "             b             ", "                           ", "                           ", "  aaaaaaaaaaaaaaaaaaaaaaa  ")
            .aisle("  aaaaaaaaaaaaaaaaaaaaaaa  ", "  c                     c  ", "  c          b          c  ", "  c         bbb         c  ", "  c         bbb         c  ", "  c          b          c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c                     c  ", "  c          b          c  ", "  c         bbb         c  ", "  c         bbb         c  ", "  c          b          c  ", "  c                     c  ", "  aaaaaaaaaaaaaaaaaaaaaaa  ")
            .aisle("   aaaaaaaaaaaaaaaaaaaaa   ", "   c         b         c   ", "   c        bbb        c   ", "   c        bbb        c   ", "   c         b         c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c                   c   ", "   c         b         c   ", "   c        bbb        c   ", "   c        bbb        c   ", "   c         b         c   ", "   aaaaaaaaaaaaaaaaaaaaa   ")
            .aisle("    aaaaaaaaaaaaaaaaaaa    ", "    c       bbb       c    ", "    c       bbb       c    ", "    c        b        c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c                 c    ", "    c        b        c    ", "    c       bbb       c    ", "    c       bbb       c    ", "    aaaaaaaaaaaaaaaaaaa    ")
            .aisle("     aaaaaaaaaaaaaaaaa     ", "     c      bbb      c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c               c     ", "     c       b       c     ", "     c      bbb      c     ", "     aaaaaaaaaaaaaaaaa     ")
            .aisle("       aaaaaaaaaaaaa       ", "             b             ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "             b             ", "       aaaaaaaaaaaaa       ")
            .aisle("          aaaaaaa          ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "                           ", "          aaaaaaa          ")
            .where(
                "a", Predicates.blocks(GTLBlocks.DIMENSION_CONNECTION_CASING.get())
                    .or(Predicates.abilities(PartAbility.IMPORT_ITEMS).setMaxGlobalLimited(1))
                    .or(Predicates.abilities(PartAbility.EXPORT_ITEMS).setMaxGlobalLimited(1))
                    .or(Predicates.abilities(PartAbility.INPUT_ENERGY).setMaxGlobalLimited(1))
                    .or(Predicates.abilities(PartAbility.COMPUTATION_DATA_RECEPTION).setMaxGlobalLimited(1))
                    .or(Predicates.abilities(GTLAddPartAbility.THREAD_MODIFIER).setMaxGlobalLimited(1))
            )
            .where("b", Predicates.blocks(Registries.getBlock("kubejs:dimensional_bridge_casing")))
            .where("c", Predicates.blocks(ChemicalHelper.getBlock(TagPrefix.frameGt, GTLMaterials.Infinity)))
            .where("d", Predicates.blocks(GTLBlocks.CREATE_CASING.get()))
            .where("e", Predicates.blocks(Registries.getBlock("kubejs:spacetime_compression_field_generator")))
            .where("f", Predicates.blocks(Registries.getBlock("kubejs:create_aggregatione_core")))
            .where("~", Predicates.controller(Predicates.blocks(definition!!.get())))
            .where(" ", Predicates.any())
            .build()
    }

    private val activeTransformer = Function { definition: MultiblockMachineDefinition? ->
        FactoryBlockPattern.start()
            .aisle("XXX", "XXX", "XXX")
            .aisle("XXX", "XCX", "XXX")
            .aisle("XXX", "XSX", "XXX")
            .where('S', Predicates.controller(Predicates.blocks(definition!!.get())))
            .where('X', Predicates.blocks(GTBlocks.HIGH_POWER_CASING.get()).or(ActiveTransformerMachine.getHatchPredicates()))
            .where('C', Predicates.blocks(GTBlocks.SUPERCONDUCTING_COIL.get()))
            .build()
    }

    private val recipeModifierList = RecipeModifierList(
        { machine: MetaMachine?, recipe: GTRecipe?, params: OCParams?, result: OCResult? ->
            GTRecipeModifiers.accurateParallel(
                machine,
                recipe!!,
                Ints.saturatedCast(1L + (machine as IThreadModifierMachine).additionalThread),
                false
            ).getFirst()
        }, GTRecipeModifiers.ELECTRIC_OVERCLOCK.apply(OverclockingLogic(1.0, 1.0, false))
    )

    @JvmStatic
    fun init() {
        AdvancedMultiBlockMachine.DOOR_OF_CREATE.patternFactory = SupplierMemoizer.memoize {
            (doorofPattern).apply(AdvancedMultiBlockMachine.DOOR_OF_CREATE)
        }
        AdvancedMultiBlockMachine.CREATE_AGGREGATION.patternFactory = SupplierMemoizer.memoize {
            (createAggregation).apply(AdvancedMultiBlockMachine.CREATE_AGGREGATION)
        }
        GTMachines.ACTIVE_TRANSFORMER.patternFactory = SupplierMemoizer.memoize {
            (activeTransformer).apply(GTMachines.ACTIVE_TRANSFORMER)
        }

        AdvancedMultiBlockMachine.CREATE_AGGREGATION.recipeModifier = recipeModifierList
        AdvancedMultiBlockMachine.DOOR_OF_CREATE.recipeModifier = recipeModifierList
        AdvancedMultiBlockMachine.CREATE_AGGREGATION.setMachineSupplier { blockEntity: IMachineBlockEntity ->
            CreateAggregation(blockEntity)
        }
        AdvancedMultiBlockMachine.DOOR_OF_CREATE.setMachineSupplier { blockEntity: IMachineBlockEntity ->
            DoorOfCreate(blockEntity)
        }
    }
}
